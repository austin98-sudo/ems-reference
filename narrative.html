<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Narrative, Phrase & Template Manager</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
  <style>
   /* Basic resets and fonts */
   body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f7fa;
      color: #333;
    }
    h2 {
      margin-top: 0
    }
    select {
      font-size: 1.25em;
    }
    /* Tab Navigation */
    #tabs {
      display: flex;
      background: #fff;
      border-bottom: 2px solid #ccc;
    }
    #tabs button {
      flex: 1;
      padding: 15px;
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      font-size: 1em;
      cursor: pointer;
      color: black;
      margin-top: 0;
      border-radius: 0;
    }
    #tabs button.active {
      border-bottom: 2px solid #4a90e2;
      font-weight: bold;
    }
    /* Containers */
    .container, .container-grid {
      display: none;
      padding: 20px;
    }
    .container.active, .container-grid.active {
      display: block;
    }
    /* Narrative Tab: 75% textarea, 25% custom phrases */
    #narrativeTab {
      display: grid;
      grid-template-columns: 75% 25%;
      grid-column-gap: 10px;
    }
    textarea {
      width: 100%;
      height: 550px;
      padding: 15px;
      font-size: 1em;
      border: 1px solid #ccc;
      border-radius: 8px;
      resize: vertical;
      box-sizing: border-box;
    }
    button {
      padding: 10px 20px;
      font-size: 1em;
      background: #4a90e2;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 10px;
    }
    button:hover {
      background: #407ac1;
    }
    button.move-up, button.move-down,button.remove-field {
      margin-top: 0;
    }
    /* Custom Phrases column */
    .phrases-container {
      height: 550px;
      overflow-y: auto;
    }
    .phrase {
      background: #e9eff6;
      border: 1px solid #cfdbe3;
      padding: 10px;
      margin-bottom: 10px;
      text-align: center;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .phrase:hover {
      background: #d8e2ed;
    }
    /* Collapsible Sections */
    .collapsible-header {
      cursor: pointer;
      background: #ddd;
      padding: 8px;
      border-radius: 4px;
      margin-bottom: 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      height: 25px;
    }
    .collapsible-content {
      padding: 8px;
      margin-top: 5px;
    }
    .arrow {
      font-size: 0.75em;
    }
    /* Phrase and Template Manager List */
    #phraseList, #templateList {
      margin-top: 20px;
    }
    .phrase-item {
      background: #f0f0f0;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .phrase-item span {
      font-weight: bold;
    }
    .phrase-actions button {
      margin-left: 5px;
      background: #4a90e2;
      border: none;
      border-radius: 3px;
      color: white;
      cursor: pointer;
      padding: 5px 8px;
      font-size: 0.9em;
      margin-top: 0;
    }
    .phrase-actions button.delete {
      background: #e74c3c;
    }
    /* Table layout for composite fields in phrase editor */
    table.fields-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    table.fields-table th,
    table.fields-table td {
      border: 1px solid #ccc;
      padding: 5px 8px;
      text-align: left;
    }
    table.fields-table th {
      background: #f0f0f0;
    }
    table.fields-table input {
      margin: 0;
    }
    /* Modal styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal {
      background: white;
      padding: 20px;
      border-radius: 8px;
      max-width: 850px;
      width: 90%;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      overflow-y: scroll;
      max-height: 90%;
    }
    /* Make phrase form modal wider */
    #phraseFormModal .modal {
      width: 90%;
      max-width: 90%;
    }
    .modal h3 {
      margin-top: 0;
    }
    .modal input, .modal textarea {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1em;
      box-sizing: border-box;
    }
    /* .modal button {
      width: 48%;
    } */
    .modal-buttons {
      display: flex;
      justify-content: space-between;
    }
  </style>
  <script src="./phrases.js"></script>
  <script src="./templates.js"></script>
</head>
<body>
  <!-- Tab Navigation -->
  <div id="tabs">
    <button id="narrativeTabBtn" class="active">Narrative</button>
    <button id="phraseTabBtn">Phrases</button>
    <button id="templateTabBtn">Templates</button>
  </div>

  <!-- Narrative Tab -->
  <div id="narrativeTab" class="container-grid active">
    <div class="narrative-container">
      <textarea id="narrative" placeholder="Type your narrative here..."></textarea>
      <button id="process" style="width: 100%;">Process Narrative</button>
    </div>
    <div class="phrases-container">
      <h2>Custom Phrases</h2>
      <div id="customPhrases">
        <!-- Phrase buttons will be injected here -->
      </div>
    </div>
  </div>

  <!-- Phrase Manager Tab -->
  <div id="phraseManagerTab" class="container">
    <h2>Phrase Manager</h2>
    <button id="createPhraseBtn">Create New Phrase</button>
    <button id="exportPhrasesBtn">Export Phrases</button>
    <div id="phraseList">
      <!-- List of phrases with Edit/Delete/Reorder actions will be shown here -->
    </div>
  </div>

  <!-- Template Manager Tab -->
  <div id="templateManagerTab" class="container">
    <h2>Template Manager</h2>
    <button id="createTemplateBtn">Create New Template</button>
    <button id="exportTemplatesBtn">Export Templates</button>
    <div id="templateList">
      <!-- List of templates with Use/Edit/Delete/Reorder actions will be shown here -->
    </div>
  </div>

  <!-- Modal for Prompting / Editing (Used for Template edits/creates, Phrase insertion, and Export) -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal">
      <h3 id="modalTitle"></h3>
      <div id="modalContent"></div>
      <div class="modal-buttons">
        <button id="modalConfirm">Confirm</button>
        <button id="modalCancel">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Modal for Phrase Form (New/Edit) -->
  <div class="modal-overlay" id="phraseFormModal" style="display:none;">
    <div class="modal">
      <div id="phraseFormContainer">
        <h3 id="formTitle">Create New Phrase</h3>
        <form id="phraseForm">
          <!-- Edit Phrase Name and Phrase Template -->
          <div>
            <label>Phrase Name:</label>
            <input type="text" id="phraseName" required />
          </div>
          <div>
            <label>Phrase Template:</label>
            <input type="text" id="phraseTemplate" placeholder="Enter phrase template" />
          </div>
          <div>
            <label>Composite Phrase?</label>
            <input type="checkbox" id="compositeCheckbox" />
          </div>
          <!-- Grouping and Visibility -->
          <div>
            <label>Section:</label>
            <input type="text" id="phraseSection" placeholder="Optional section name" />
          </div>
          <div>
            <label>Visible in Narrative Tab?</label>
            <input type="checkbox" id="phraseVisible" checked />
          </div>
          <!-- Simple phrase fields -->
          <div id="simplePhraseFields">
            <div>
              <label>Field Type:</label>
              <select id="simpleFieldType">
                <option value="input">Input</option>
                <option value="select">Select</option>
              </select>
            </div>
            <div>
              <label>Placeholder:</label>
              <input type="text" id="simplePlaceholder" />
            </div>
            <div>
              <label>Default Value:</label>
              <input type="text" id="simpleDefault" />
            </div>
            <div id="simpleOptionsContainer" style="display:none;">
              <label>Options (comma separated):</label>
              <input type="text" id="simpleOptions" />
            </div>
          </div>
          <!-- Composite phrase fields as a table -->
          <div id="compositePhraseFields" style="display:none;">
            <table class="fields-table" id="fieldsTable">
              <thead>
                <tr>
                  <th>Field Name</th>
                  <th>Field Type</th>
                  <th>Multiple?</th>
                  <th>Placeholder</th>
                  <th>Default</th>
                  <th>Options</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="fieldsTableBody">
                <!-- Rows added dynamically -->
              </tbody>
            </table>
            <button type="button" id="addFieldButton">Add Field</button>
          </div>
          <div style="text-align: right; margin-top:10px;">
            <button type="submit">Save Phrase</button>
            <button type="button" id="cancelPhraseBtn">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    /***** Global Data and Persistence *****/
    // let predefinedPhrases = {
    //   "dispatch info": {
    //     template: "{0} was dispatched for {1}.",
    //     order: 1000,
    //     visible: true,
    //     section: "Pre-Generated"
    //   },
    //   "complaints": {
    //     template: "Pt presents with {0}.",
    //     order: 2000,
    //     visible: true,
    //     section: "Pre-Generated"
    //   }
    // };
    // let narrativeTemplates = {
    //   "Default Template": {
    //     content: "D- {dispatch info}.\n\nC- {complaints}\n\nH- \n\nA- {arrival}\n\nABC: {abc}\nNEURO: {neuro}",
    //     order: 1000
    //   }
    // };
    // function loadPhrases() {
    //   const stored = localStorage.getItem('predefinedPhrases');
    //   if (stored) {
    //     predefinedPhrases = JSON.parse(stored);
    //   }
    // }
    // function savePhrases() {
    //   localStorage.setItem('predefinedPhrases', JSON.stringify(predefinedPhrases));
    // }
    // function loadTemplates() {
    //   const stored = localStorage.getItem('narrativeTemplates');
    //   if (stored) {
    //     narrativeTemplates = JSON.parse(stored);
    //   }
    // }
    // function saveTemplates() {
    //   localStorage.setItem('narrativeTemplates', JSON.stringify(narrativeTemplates));
    // }

    /***** Tab Navigation *****/
    const narrativeTabBtn = document.getElementById("narrativeTabBtn");
    const phraseTabBtn = document.getElementById("phraseTabBtn");
    const templateTabBtn = document.getElementById("templateTabBtn");
    const narrativeTab = document.getElementById("narrativeTab");
    const phraseManagerTab = document.getElementById("phraseManagerTab");
    const templateManagerTab = document.getElementById("templateManagerTab");
    function showTab(tab) {
      narrativeTab.style.display = "none";
      phraseManagerTab.style.display = "none";
      templateManagerTab.style.display = "none";
      narrativeTabBtn.classList.remove("active");
      phraseTabBtn.classList.remove("active");
      templateTabBtn.classList.remove("active");
      tab.style.display = (tab.id != "narrativeTab") ? "block" : "grid";
    }
    narrativeTabBtn.addEventListener("click", () => {
      showTab(narrativeTab);
      narrativeTabBtn.classList.add("active");
    });
    phraseTabBtn.addEventListener("click", () => {
      showTab(phraseManagerTab);
      phraseTabBtn.classList.add("active");
      renderPhraseList();
    });
    templateTabBtn.addEventListener("click", () => {
      showTab(templateManagerTab);
      templateTabBtn.classList.add("active");
      renderTemplateList();
    });

    /***** Narrative Functions *****/
    function insertAtCursor(field, value) {
      field.focus();
      if (document.selection) {
        const sel = document.selection.createRange();
        sel.text = value;
      } else if (typeof field.selectionStart === "number") {
        const startPos = field.selectionStart;
        const endPos = field.selectionEnd;
        field.value = field.value.substring(0, startPos) + value + field.value.substring(endPos);
        field.selectionStart = startPos + value.length;
        field.selectionEnd = startPos + value.length;
      } else {
        field.value += value;
      }
      field.focus();
    }
    document.getElementById("process").addEventListener("click", () => {
      const narrativeField = document.getElementById("narrative");
      processNarrativeTokens(narrativeField);
    });

    /***** Process Narrative Tokens *****/
    function processNarrativeTokens(narrativeField) {
      const text = narrativeField.value;
      const tokenRegex = /{([^}]+)}/g;
      const tokens = Array.from(text.matchAll(tokenRegex));
      processNextToken(narrativeField, tokens, 0);
    }
    function processNextToken(narrativeField, tokens, index) {
      if (index >= tokens.length) return;
      const token = tokens[index];
      const fullToken = token[0];
      const key = token[1].trim();
      const phraseData = predefinedPhrases[key];
      if (!phraseData) {
        const value = prompt("Enter value for " + key + ":");
        narrativeField.value = narrativeField.value.replace(fullToken, value || "");
        processNextToken(narrativeField, tokens, index + 1);
      } else {
        if (phraseData.fields) {
          askSequentialField(key, phraseData, 0, [], (answers) => {
            const finalValue = phraseData.template ? formatTemplate(phraseData.template, answers) : answers.join(" ");
            narrativeField.value = narrativeField.value.replace(fullToken, finalValue);
            processNextToken(narrativeField, tokens, index + 1);
          });
        } else if (phraseData.type && phraseData.type === "select") {
          openSimpleSelectPrompt(key, () => {
            // After selection, re-read tokens and continue processing.
            processNarrativeTokens(narrativeField);
          });
        } else {
          const value = prompt("Enter value for " + key + ":");
          narrativeField.value = narrativeField.value.replace(fullToken, value || "");
          processNextToken(narrativeField, tokens, index + 1);
        }
      }
    }
    function formatTemplate(template, answers) {
      return template.replace(/{\s*(\d+)\s*}/g, (match, index) => answers[index] || "");
    }

    /***** Modal Helper Functions *****/
    function showModal(title, contentElement, confirmCallback) {
      const modalOverlay = document.getElementById("modalOverlay");
      const modalTitle = document.getElementById("modalTitle");
      const modalContent = document.getElementById("modalContent");
      const modalConfirm = document.getElementById("modalConfirm");
      const modalCancel = document.getElementById("modalCancel");
      modalTitle.textContent = title;
      modalContent.innerHTML = "";
      modalContent.appendChild(contentElement);
      modalOverlay.style.display = "flex";
      modalConfirm.onclick = function() {
        confirmCallback();
        closeModal();
      };
      modalCancel.onclick = function() {
        closeModal();
      };
    }
    function closeModal() {
      document.getElementById("modalOverlay").style.display = "none";
      document.getElementById("modalConfirm").style.display = "block";
    }

    /***** Function for Simple Select Prompt *****/
    function openSimpleSelectPrompt(key, callback) {
      const narrativeField = document.getElementById("narrative");
      const phraseData = predefinedPhrases[key];
      const container = document.createElement("div");
      const selectElement = document.createElement("select");
      if (phraseData.multiple) {
        selectElement.multiple = true;
      }
      if (phraseData.options && phraseData.options.length > 0) {
        phraseData.options.forEach(option => {
          const opt = document.createElement("option");
          opt.value = option;
          opt.textContent = option;
          selectElement.appendChild(opt);
        });
      } else {
        selectElement.innerHTML = `<option value="">No options available</option>`;
      }
      container.appendChild(selectElement);
      showModal(`Select value for ${key}`, container, () => {
        let value;
        if (selectElement.multiple) {
          value = Array.from(selectElement.selectedOptions).map(opt => opt.value).join(", ");
        } else {
          value = selectElement.value;
        }
        insertAtCursor(narrativeField, value);
        if (callback) callback();
      });
    }

    /***** Phrase Insertion Modal for Composite Phrases *****/
    function askSequentialField(key, phraseData, index, answers, finalCallback) {
      if (index >= phraseData.fields.length) {
        finalCallback(answers);
        return;
      }
      const field = phraseData.fields[index];
      const container = document.createElement("div");
      container.style.marginBottom = "10px";
      
      const label = document.createElement("label");
      label.textContent = field.label;
      label.style.display = "block";
      label.style.marginBottom = "5px";
      container.appendChild(label);
      
      let input;
      if (field.type === "select") {
        input = document.createElement("select");
        if (field.multiple) {
          input.multiple = true;
        }
        field.options.forEach(option => {
          const opt = document.createElement("option");
          opt.value = option;
          opt.textContent = option;
          input.appendChild(opt);
        });
        if (field.default) {
          input.value = field.default;
        }
      } else {
        input = document.createElement("input");
        input.type = "text";
        input.placeholder = field.placeholder || "";
        if (field.default) {
          input.value = field.default;
        }
      }
      input.style.width = "100%";
      input.style.padding = "8px";
      input.style.boxSizing = "border-box";
      container.appendChild(input);
      
      // Live preview area.
      const previewDiv = document.createElement("div");
      previewDiv.style.marginTop = "10px";
      previewDiv.style.padding = "10px";
      previewDiv.style.border = "1px solid #ccc";
      previewDiv.style.borderRadius = "4px";
      previewDiv.style.backgroundColor = "#f9f9f9";
      container.appendChild(previewDiv);
      
      function updatePreview() {
        const total = phraseData.fields.length;
        const allAnswers = [];
        for (let i = 0; i < total; i++) {
          if (i < index) {
            allAnswers.push(answers[i]);
          } else if (i === index) {
            let current;
            if (input.tagName.toLowerCase() === "select" && input.multiple) {
              current = Array.from(input.selectedOptions).map(opt => opt.value).join(", ");
            } else {
              current = input.value;
            }
            allAnswers.push(current);
          } else {
            allAnswers.push(phraseData.fields[i].default || "");
          }
        }
        let previewText = "";
        if (phraseData.template) {
          previewText = formatTemplate(phraseData.template, allAnswers);
        } else {
          previewText = allAnswers.join(" ");
        }
        previewDiv.textContent = "Preview: " + previewText;
      }
      input.addEventListener("input", updatePreview);
      input.addEventListener("change", updatePreview);
      updatePreview();
      
      showModal(`Enter ${field.label}`, container, () => {
        let answer;
        if (input.tagName.toLowerCase() === "select" && input.multiple) {
          answer = Array.from(input.selectedOptions).map(opt => opt.value).join(", ");
        } else {
          answer = input.value;
        }
        answers.push(answer);
        setTimeout(() => {
          askSequentialField(key, phraseData, index + 1, answers, finalCallback);
        }, 100);
      });
    }

    /***** Generate Phrase Buttons in Narrative Tab *****/
    function generatePhraseButtons() {
      const container = document.getElementById("customPhrases");
      container.innerHTML = "";
      let phrasesArr = [];
      for (const key in predefinedPhrases) {
        const phrase = predefinedPhrases[key];
        if (phrase.visible === false) continue;
        phrase.name = key;
        phrasesArr.push(phrase);
      }
      // Group phrases by section.
      let groups = {};
      phrasesArr.forEach(phrase => {
        const section = phrase.section || "Default";
        if (!groups[section]) groups[section] = [];
        groups[section].push(phrase);
      });
      for (const section in groups) {
        const groupDiv = document.createElement("div");
        const header = document.createElement("h3");
        header.className = "collapsible-header";
        header.innerHTML = `<span class="section-title">${section}</span><span class="arrow">&#x25BC;</span>`;
        groupDiv.appendChild(header);
        const contentDiv = document.createElement("div");
        contentDiv.className = "collapsible-content";
        contentDiv.style.display = "block";
        groups[section].sort((a, b) => (a.order || 0) - (b.order || 0));
        groups[section].forEach(phrase => {
          const btn = document.createElement("div");
          btn.className = "phrase";
          btn.textContent = `{${phrase.name}}`;
          btn.addEventListener("click", () => {
            if (phrase.fields) {
              openPhrasePrompt(phrase.name);
            } else if (phrase.type && phrase.type === "select") {
              openSimpleSelectPrompt(phrase.name);
            } else {
              let value = prompt("Enter value for " + phrase.name + ":");
              if (value !== null) {
                insertAtCursor(document.getElementById("narrative"), value);
              }
            }
          });
          contentDiv.appendChild(btn);
        });
        header.addEventListener("click", () => {
          let currentDisplay = window.getComputedStyle(contentDiv).display;
          if (currentDisplay === "none") {
            contentDiv.style.display = "block";
            header.querySelector(".arrow").innerHTML = "&#x25BC;";
          } else {
            contentDiv.style.display = "none";
            header.querySelector(".arrow").innerHTML = "&#x25B2;";
          }
        });
        groupDiv.appendChild(contentDiv);
        container.appendChild(groupDiv);
      }
    }

    /***** Phrase Manager Functions *****/
    function renderPhraseList() {
      const phraseList = document.getElementById("phraseList");
      phraseList.innerHTML = "";
      let phrasesArr = [];
      for (const key in predefinedPhrases) {
        let ph = predefinedPhrases[key];
        ph.name = key;
        phrasesArr.push(ph);
      }
      // Group by section.
      let groups = {};
      phrasesArr.forEach(ph => {
        const sec = ph.section || "Default";
        if (!groups[sec]) groups[sec] = [];
        groups[sec].push(ph);
      });
      for (const sec in groups) {
        const groupDiv = document.createElement("div");
        const header = document.createElement("h3");
        header.innerHTML = `<span class="section-title">${sec}</span><span class="arrow">&#x25BC;</span>`;
        header.className = "collapsible-header";
        groupDiv.appendChild(header);
        const contentDiv = document.createElement("div");
        contentDiv.className = "collapsible-content";
        contentDiv.style.display = "block";
        groups[sec].sort((a, b) => (a.order || 0) - (b.order || 0));
        groups[sec].forEach(ph => {
          const row = document.createElement("div");
          row.className = "phrase-item";
          row.innerHTML = `<span>${ph.name}</span>`;
          const actions = document.createElement("div");
          actions.className = "phrase-actions";
          const upBtn = document.createElement("button");
          upBtn.innerHTML = "&#x25B2;";
          upBtn.title = "Move Up";
          upBtn.addEventListener("click", () => movePhrase(ph.name, -1));
          const downBtn = document.createElement("button");
          downBtn.innerHTML = "&#x25BC;";
          downBtn.title = "Move Down";
          downBtn.addEventListener("click", () => movePhrase(ph.name, 1));
          const editBtn = document.createElement("button");
          editBtn.textContent = "Edit";
          editBtn.addEventListener("click", () => loadPhraseForEditing(ph.name));
          const deleteBtn = document.createElement("button");
          deleteBtn.textContent = "Delete";
          deleteBtn.className = "delete";
          deleteBtn.addEventListener("click", () => {
            if (confirm(`Delete phrase "${ph.name}"?`)) {
              delete predefinedPhrases[ph.name];
              // savePhrases();
              renderPhraseList();
              generatePhraseButtons();
            }
          });
          actions.appendChild(upBtn);
          actions.appendChild(downBtn);
          actions.appendChild(editBtn);
          actions.appendChild(deleteBtn);
          row.appendChild(actions);
          contentDiv.appendChild(row);
        });
        header.addEventListener("click", () => {
          let currentDisplay = window.getComputedStyle(contentDiv).display;
          if (currentDisplay === "none") {
            contentDiv.style.display = "block";
            header.querySelector(".arrow").innerHTML = "&#x25BC;";
          } else {
            contentDiv.style.display = "none";
            header.querySelector(".arrow").innerHTML = "&#x25B2;";
          }
        });
        groupDiv.appendChild(contentDiv);
        phraseList.appendChild(groupDiv);
      }
    }
    function movePhrase(key, delta) {
      let ph = predefinedPhrases[key];
      if (!ph) return;
      const sec = ph.section || "Default";
      let arr = [];
      for (const k in predefinedPhrases) {
        let p = predefinedPhrases[k];
        if ((p.section || "Default") === sec) {
          p.name = k;
          arr.push(p);
        }
      }
      arr.sort((a, b) => (a.order || 0) - (b.order || 0));
      const idx = arr.findIndex(p => p.name === key);
      if (idx === -1) return;
      const newIndex = idx + delta;
      if (newIndex < 0 || newIndex >= arr.length) return;
      let temp = arr[idx].order;
      arr[idx].order = arr[newIndex].order;
      arr[newIndex].order = temp;
      predefinedPhrases[arr[idx].name].order = arr[idx].order;
      predefinedPhrases[arr[newIndex].name].order = arr[newIndex].order;
      // savePhrases();
      renderPhraseList();
      generatePhraseButtons();
    }
    function loadPhraseForEditing(key) {
      window.editingPhraseKey = key;
      document.getElementById("formTitle").textContent = "Edit Phrase: " + key;
      const phrase = predefinedPhrases[key];
      document.getElementById("phraseName").value = key;
      document.getElementById("phraseTemplate").value = phrase.template || "";
      document.getElementById("phraseSection").value = phrase.section || "";
      document.getElementById("phraseVisible").checked = phrase.visible !== false;
      if (phrase.fields) {
        document.getElementById("compositeCheckbox").checked = true;
        document.getElementById("simplePhraseFields").style.display = "none";
        document.getElementById("compositePhraseFields").style.display = "block";
        document.getElementById("fieldsTableBody").innerHTML = "";
        phrase.fields.forEach(field => {
          addCompositeFieldRow(field);
        });
      } else {
        document.getElementById("compositeCheckbox").checked = false;
        document.getElementById("simplePhraseFields").style.display = "block";
        document.getElementById("compositePhraseFields").style.display = "none";
        document.getElementById("simpleFieldType").value = phrase.type;
        document.getElementById("simplePlaceholder").value = phrase.placeholder || "";
        document.getElementById("simpleDefault").value = phrase.default || "";
        if (phrase.type === "select") {
          document.getElementById("simpleOptions").value = phrase.options ? phrase.options.join(", ") : "";
          document.getElementById("simpleOptionsContainer").style.display = "block";
        } else {
          document.getElementById("simpleOptionsContainer").style.display = "none";
        }
      }
      document.getElementById("phraseFormModal").style.display = "flex";
    }
    document.getElementById("createPhraseBtn").addEventListener("click", () => {
      window.editingPhraseKey = null;
      document.getElementById("formTitle").textContent = "Create New Phrase";
      document.getElementById("phraseForm").reset();
      document.getElementById("simplePhraseFields").style.display = "block";
      document.getElementById("compositePhraseFields").style.display = "none";
      document.getElementById("phraseFormModal").style.display = "flex";
    });

    /***** Hide/Show Options *****/
    document.getElementById("simpleFieldType").addEventListener("change", () => {
      if (document.getElementById("simpleFieldType").value === "select") {
        document.getElementById("simpleOptionsContainer").style.display = "block";
        document.getElementById("simpleDefault").parentElement.style.display = "none";
        document.getElementById("simplePlaceholder").parentElement.style.display = "none";
      } else {
        document.getElementById("simpleOptionsContainer").style.display = "none";
        document.getElementById("simpleDefault").parentElement.style.display = "block";
        document.getElementById("simplePlaceholder").parentElement.style.display = "block";
      }
    })

    /***** Composite Fields Table Functions *****/
    function addCompositeFieldRow(rowData) {
      const tbody = document.getElementById("fieldsTableBody");
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input type="text" class="field-label" value="${rowData && rowData.label ? rowData.label : ''}" /></td>
        <td>
          <select class="field-type">
            <option value="input">Input</option>
            <option value="select">Select</option>
          </select>
        </td>
        <td><input type="checkbox" class="field-multiple" ${rowData && rowData.multiple ? "checked" : ""} /></td>
        <td><input type="text" class="field-placeholder" value="${rowData && rowData.placeholder ? rowData.placeholder : ''}" /></td>
        <td><input type="text" class="field-default" value="${rowData && rowData.default ? rowData.default : ''}" /></td>
        <td><input type="text" class="field-options" value="${rowData && rowData.options ? rowData.options.join(", ") : ''}" /></td>
        <td>
          <button type="button" class="move-up" title="Move Up">&#x25B2;</button>
          <button type="button" class="move-down" title="Move Down">&#x25BC;</button>
          <button type="button" class="remove-field">Remove</button>
        </td>
      `;
      if (rowData && rowData.type) {
        tr.querySelector(".field-type").value = rowData.type;
      }
      tr.querySelector(".move-up").addEventListener("click", () => {
        let prev = tr.previousElementSibling;
        if (prev) {
          tr.parentElement.insertBefore(tr, prev);
        }
      });
      tr.querySelector(".move-down").addEventListener("click", () => {
        let next = tr.nextElementSibling;
        if (next) {
          tr.parentElement.insertBefore(next, tr);
        }
      });
      tr.querySelector(".remove-field").addEventListener("click", () => {
        tbody.removeChild(tr);
      });
      tbody.appendChild(tr);
    }
    document.getElementById("addFieldButton").addEventListener("click", () => {
      addCompositeFieldRow();
    });
    document.getElementById("cancelPhraseBtn").addEventListener("click", () => {
      document.getElementById("phraseFormModal").style.display = "none";
    });
    document.getElementById("phraseForm").addEventListener("submit", (e) => {
      e.preventDefault();
      const name = document.getElementById("phraseName").value.trim();
      if (!name) return;
      const phraseTemplate = document.getElementById("phraseTemplate").value.trim();
      let newPhrase;
      if (!document.getElementById("compositeCheckbox").checked) {
        const type = document.getElementById("simpleFieldType").value;
        const placeholder = document.getElementById("simplePlaceholder").value;
        const def = document.getElementById("simpleDefault").value;
        if (type === "select") {
          const options = document.getElementById("simpleOptions").value.split(",").map(s => s.trim()).filter(s => s);
          newPhrase = { type, placeholder, default: def, options };
        } else {
          newPhrase = { type, placeholder, default: def };
        }
        newPhrase.template = phraseTemplate;
      } else {
        const fields = [];
        const tbody = document.getElementById("fieldsTableBody");
        const rows = tbody.querySelectorAll("tr");
        rows.forEach(row => {
          const label = row.querySelector(".field-label").value.trim();
          if (!label) return;
          const type = row.querySelector(".field-type").value;
          const placeholder = row.querySelector(".field-placeholder").value;
          const def = row.querySelector(".field-default").value;
          const multiple = row.querySelector(".field-multiple").checked;
          let fieldObj = { label, type, placeholder, default: def };
          if (type === "select") {
            const options = row.querySelector(".field-options").value.split(",").map(s => s.trim()).filter(s => s);
            fieldObj.options = options;
            fieldObj.multiple = multiple;
          }
          fields.push(fieldObj);
        });
        newPhrase = { fields, template: phraseTemplate };
      }
      const section = document.getElementById("phraseSection").value.trim();
      const visible = document.getElementById("phraseVisible").checked;
      newPhrase.section = section;
      newPhrase.visible = visible;
      if (!window.editingPhraseKey) {
        newPhrase.order = Date.now();
      } else {
        newPhrase.order = predefinedPhrases[window.editingPhraseKey].order || Date.now();
      }
      if (window.editingPhraseKey && window.editingPhraseKey !== name) {
        delete predefinedPhrases[window.editingPhraseKey];
      }
      predefinedPhrases[name] = newPhrase;
      // savePhrases();
      renderPhraseList();
      generatePhraseButtons();
      document.getElementById("phraseFormModal").style.display = "none";
      document.getElementById("phraseForm").reset();
      document.getElementById("fieldsTableBody").innerHTML = "";
    });

    /***** Template Manager Functions *****/
    function renderTemplateList() {
      const templateList = document.getElementById("templateList");
      templateList.innerHTML = "";
      let templatesArr = [];
      for (const key in narrativeTemplates) {
        let tpl = narrativeTemplates[key];
        tpl.name = key;
        templatesArr.push(tpl);
      }
      templatesArr.sort((a, b) => (a.order || 0) - (b.order || 0));
      templatesArr.forEach(tpl => {
        const row = document.createElement("div");
        row.className = "phrase-item";
        row.innerHTML = `<span>${tpl.name}</span>`;
        const actions = document.createElement("div");
        actions.className = "phrase-actions";
        const upBtn = document.createElement("button");
        upBtn.innerHTML = "&#x25B2;";
        upBtn.title = "Move Up";
        upBtn.addEventListener("click", () => moveTemplate(tpl.name, -1));
        const downBtn = document.createElement("button");
        downBtn.innerHTML = "&#x25BC;";
        downBtn.title = "Move Down";
        downBtn.addEventListener("click", () => moveTemplate(tpl.name, 1));
        const editBtn = document.createElement("button");
        editBtn.textContent = "Edit";
        editBtn.addEventListener("click", () => showTemplateEditModal(tpl.name));
        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "Delete";
        deleteBtn.className = "delete";
        deleteBtn.addEventListener("click", () => {
          if (confirm(`Delete template "${tpl.name}"?`)) {
            delete narrativeTemplates[tpl.name];
            // saveTemplates();
            renderTemplateList();
          }
        });
        const useBtn = document.createElement("button");
        useBtn.textContent = "Use Template";
        useBtn.addEventListener("click", () => {
          const narrativeField = document.getElementById("narrative");
          narrativeField.value = tpl.content;
          narrativeTabBtn.click();
        });
        actions.appendChild(upBtn);
        actions.appendChild(downBtn);
        actions.appendChild(editBtn);
        actions.appendChild(deleteBtn);
        actions.appendChild(useBtn);
        row.appendChild(actions);
        templateList.appendChild(row);
      });
    }
    function moveTemplate(key, delta) {
      let tpl = narrativeTemplates[key];
      if (!tpl) return;
      let arr = [];
      for (const k in narrativeTemplates) {
        let t = narrativeTemplates[k];
        t.name = k;
        arr.push(t);
      }
      arr.sort((a, b) => (a.order || 0) - (b.order || 0));
      const idx = arr.findIndex(t => t.name === key);
      if (idx === -1) return;
      const newIndex = idx + delta;
      if (newIndex < 0 || newIndex >= arr.length) return;
      let temp = arr[idx].order;
      arr[idx].order = arr[newIndex].order;
      arr[newIndex].order = temp;
      narrativeTemplates[arr[idx].name].order = arr[idx].order;
      narrativeTemplates[arr[newIndex].name].order = arr[newIndex].order;
      // saveTemplates();
      renderTemplateList();
    }
    function showTemplateEditModal(key) {
      const tpl = narrativeTemplates[key];
      const modalTitle = document.getElementById("modalTitle");
      const modalContent = document.getElementById("modalContent");
      modalTitle.textContent = "Edit Template";
      modalContent.innerHTML = `
        <label>Template Name:</label>
        <input type="text" id="templateNameEdit" value="${key}" />
        <label>Template Content:</label>
        <textarea id="templateContentEdit" rows="6" style="height: 500px">${tpl.content}</textarea>
      `;
      document.getElementById("modalConfirm").onclick = function() {
        const newName = document.getElementById("templateNameEdit").value.trim();
        const newContent = document.getElementById("templateContentEdit").value;
        if (!newName) return;
        let order = tpl.order;
        delete narrativeTemplates[key];
        narrativeTemplates[newName] = { content: newContent, order: order };
        // saveTemplates();
        renderTemplateList();
        closeModal();
      };
      document.getElementById("modalCancel").onclick = closeModal;
      document.getElementById("modalOverlay").style.display = "flex";
    }
    function showTemplateCreateModal() {
      const modalTitle = document.getElementById("modalTitle");
      const modalContent = document.getElementById("modalContent");
      modalTitle.textContent = "Create Template";
      modalContent.innerHTML = `
        <label>Template Name:</label>
        <input type="text" id="templateNameCreate" placeholder="Template Name" />
        <label>Template Content:</label>
        <textarea id="templateContentCreate" rows="6" placeholder="Template Content"></textarea>
      `;
      document.getElementById("modalConfirm").onclick = function() {
        const newName = document.getElementById("templateNameCreate").value.trim();
        const newContent = document.getElementById("templateContentCreate").value;
        if (!newName) return;
        narrativeTemplates[newName] = { content: newContent, order: Date.now() };
        // saveTemplates();
        renderTemplateList();
        closeModal();
      };
      document.getElementById("modalCancel").onclick = closeModal;
      document.getElementById("modalOverlay").style.display = "flex";
    }
    document.getElementById("createTemplateBtn").addEventListener("click", () => {
      showTemplateCreateModal();
    });

    /***** Export Functions *****/
    function exportPhrases() {
      const exportStr = JSON.stringify(predefinedPhrases, null, 2);
      const container = document.createElement("div");
      const textarea = document.createElement("textarea");
      textarea.value = exportStr;
      textarea.style.width = "100%";
      textarea.style.height = "200px";
      textarea.readOnly = true;
      container.appendChild(textarea);
      showModal("Export Phrases", container, () => {});
      document.getElementById("modalConfirm").style.display = "none";
    }
    function exportTemplates() {
      const exportStr = JSON.stringify(narrativeTemplates, null, 2);
      const container = document.createElement("div");
      const textarea = document.createElement("textarea");
      textarea.value = exportStr;
      textarea.style.width = "100%";
      textarea.style.height = "200px";
      textarea.readOnly = true;
      container.appendChild(textarea);
      showModal("Export Templates", container, () => {});
      document.getElementById("modalConfirm").style.display = "none";
    }
    document.getElementById("exportPhrasesBtn").addEventListener("click", exportPhrases);
    document.getElementById("exportTemplatesBtn").addEventListener("click", exportTemplates);

    /***** Immediate Toggle for Composite Checkbox *****/
    document.getElementById("compositeCheckbox").addEventListener("change", function() {
      if (this.checked) {
        document.getElementById("simplePhraseFields").style.display = "none";
        document.getElementById("compositePhraseFields").style.display = "block";
      } else {
        document.getElementById("simplePhraseFields").style.display = "block";
        document.getElementById("compositePhraseFields").style.display = "none";
      }
    });

    function openPhrasePrompt(key) {
      const narrativeField = document.getElementById("narrative");
      const phraseData = predefinedPhrases[key];
      if (!phraseData) {
        const value = prompt("Enter value for " + key + ":");
        if (value !== null) {
          insertAtCursor(narrativeField, value);
        }
        return;
      }
      if (phraseData.fields) {
        askSequentialField(key, phraseData, 0, [], (answers) => {
          let finalValue = "";
          if (phraseData.template) {
            finalValue = formatTemplate(phraseData.template, answers);
          } else if (typeof phraseData.previewTemplate === "function") {
            finalValue = phraseData.previewTemplate(answers);
          } else {
            finalValue = answers.join(" ");
          }
          insertAtCursor(narrativeField, finalValue);
        });
      } else if (phraseData.type === "select") {
        const inputElement = document.createElement("select");
        if (phraseData.multiple) inputElement.multiple = true;
        phraseData.options.forEach(option => {
          const opt = document.createElement("option");
          opt.value = option;
          opt.textContent = option;
          inputElement.appendChild(opt);
        });
        if (phraseData.default) {
          inputElement.value = phraseData.default;
        }
        showModal(`Enter value for ${key}`, inputElement, () => {
          let selectedValue = (phraseData.multiple) ?
            Array.from(inputElement.selectedOptions).map(opt => opt.value).join(", ") :
            inputElement.value;
          insertAtCursor(narrativeField, selectedValue);
        });
      } else {
        const inputElement = document.createElement("input");
        inputElement.type = "text";
        inputElement.placeholder = phraseData.placeholder || "";
        if (phraseData.default) inputElement.value = phraseData.default;
        showModal(`Enter value for ${key}`, inputElement, () => {
          const value = inputElement.value;
          insertAtCursor(narrativeField, value);
        });
      }
    }

    /***** Initialization *****/
    document.addEventListener("DOMContentLoaded", () => {
      // loadPhrases();
      // loadTemplates();
      generatePhraseButtons();
    });
  </script>
</body>
</html>
